language: go
go_import_path: github.com/teiid/teiid-operator

go:
  - 1.13.x
  
dist: bionic
  
sudo: required
  
env:
  - DEP_RELEASE_TAG="v0.5.1"

before_install:
  # Setup dependency management tool
  - curl https://raw.githubusercontent.com/golang/dep/master/install.sh | sh
  - dep version
  - . /etc/os-release
  - sudo sh -c "echo 'deb http://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/x${ID^}_${VERSION_ID}/ /' > /etc/apt/sources.list.d/devel:kubic:libcontainers:stable.list"
  - wget -nv https://download.opensuse.org/repositories/devel:kubic:libcontainers:stable/x${ID^}_${VERSION_ID}/Release.key -O Release.key
  - sudo apt-key add - < Release.key
  - sudo apt-get update -qq
  - sudo apt-get -qq -y install buildah

install:
- make install

script:
- make test
- make build

deploy:
  provider: script
  condition: -n "$QUAY_USERNAME"
  script: "buildah login -u $QUAY_USERNAME -p $QUAY_PASSWORD quay.io && make quay-push"
  skip_cleanup: true
  on: 
    tags: false
    branch: master
    repo: teiid/teiid-operator
